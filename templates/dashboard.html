<!doctype html>
<html lang="{{ 'si' if g.lang == 'si' else 'en' }}">
<head>
  <meta charset="utf-8">
  <title>
    {% if g.lang == 'si' %}ප්ලොට් (Dashboard){% else %}Plots{% endif %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    (function () {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.setAttribute('data-bs-theme', theme);
    })();
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    .dash-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .dash-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(99,102,241,.35);
    }
    .chart-box { min-height: 360px; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div class="d-flex align-items-center gap-2">
      <h1 class="h4 mb-0">
        {% if g.lang == 'si' %}ඔබගේ ප්ලොට් {% else %}Your Plots{% endif %} 
      </h1>
      {% if not has_data %}
        <span class="badge bg-warning text-dark ms-1">
          {% if g.lang == 'si' %}දත්ත නොමැත{% else %}No data yet{% endif %}
        </span>
      {% endif %}
    </div>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('user_panel') }}">
        {% if g.lang == 'si' %}පුවරුව{% else %}User Panel{% endif %}
      </a>
      <a class="btn btn-outline-success btn-sm" href="{{ url_for('assessment') }}">
        {% if g.lang == 'si' %}නව තක්සේරුව{% else %}New Assessment{% endif %}
      </a>
      <div class="btn-group">
        <a href="{{ url_for('set_language', code='en') }}"
           class="btn btn-sm btn-outline-secondary {% if g.lang == 'en' %}active{% endif %}">EN</a>
        <a href="{{ url_for('set_language', code='si') }}"
           class="btn btn-sm btn-outline-secondary {% if g.lang == 'si' %}active{% endif %}">සි</a>
      </div>
      <div class="btn-group" role="group" aria-label="Theme">
        <button id="themeLight" type="button" class="btn btn-sm btn-outline-secondary" title="Light">
          <i class="bi bi-sun"></i>
        </button>
        <button id="themeDark" type="button" class="btn btn-sm btn-outline-secondary" title="Dark">
          <i class="bi bi-moon-stars"></i>
        </button>
      </div>
    </div>
  </div>

  {% if not has_data %}
    <div class="alert alert-info">
      {% if g.lang == 'si' %}
        ඔබගේ පුවරුව දැක්වීමට තක්සේරුවක් සුරකින්න. “නව තක්සේරුව” ක්ලික් කර පරීක්ෂණය කරන්න.
      {% else %}
        Save at least one assessment to see charts here. Click “New Assessment” to start.
      {% endif %}
    </div>
  {% else %}
    <div class="row g-3 mb-1">
      <div class="col-lg-6">
        <div class="dash-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">
              {% if g.lang == 'si' %}මධ්‍යම+දරුණු සම්භාවිතාව (කාලය අනුව){% else %}Moderate+Severe Probability (over time){% endif %}
            </div>
          </div>
          <div id="probChart" class="chart-box"></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="dash-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">
              {% if g.lang == 'si' %}DASS-42 උප-ඒකක ලකුණු (කාලය අනුව){% else %}DASS-42 Subscale Sums (over time){% endif %}
            </div>
          </div>
          <div id="scoreChart" class="chart-box"></div>
        </div>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="dash-card">
          <div class="fw-semibold mb-2">
            {% if g.lang == 'si' %}මානසික අවපීඩනය – මෑත{% else %}Depression – Recent{% endif %}
          </div>
          <div id="depStack" class="chart-box"></div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="dash-card">
          <div class="fw-semibold mb-2">
            {% if g.lang == 'si' %}කාංසාව – මෑත{% else %}Anxiety – Recent{% endif %}
          </div>
          <div id="anxStack" class="chart-box"></div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="dash-card">
          <div class="fw-semibold mb-2">
            {% if g.lang == 'si' %}ආතතිය – මෑත{% else %}Stress – Recent{% endif %}
          </div>
          <div id="strStack" class="chart-box"></div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

{% if has_data %}
<script>
  const FIG_PROB   = JSON.parse({{ fig_prob|tojson }});
  const FIG_SCORES = JSON.parse({{ fig_scores|tojson }});
  const FIG_DEP    = JSON.parse({{ fig_dep_stack|tojson }});
  const FIG_ANX    = JSON.parse({{ fig_anx_stack|tojson }});
  const FIG_STR    = JSON.parse({{ fig_str_stack|tojson }});

  function plotlyTemplate() {
    const theme = document.documentElement.getAttribute('data-theme') || 'light';
    return (theme === 'dark') ? 'plotly_dark' : 'plotly';
  }

  function normalizeLayout(fig) {
    fig.layout = fig.layout || {};
    fig.layout.template = plotlyTemplate();
    fig.layout.paper_bgcolor = 'rgba(0,0,0,0)';
    fig.layout.plot_bgcolor  = 'rgba(0,0,0,0)';
    if (fig.layout.title) delete fig.layout.title;
    const existingLegend = fig.layout.legend || {};
    fig.layout.legend = Object.assign({}, existingLegend, {
      orientation: 'h',
      x: 0.5, xanchor: 'center',
      y: 1.02, yanchor: 'bottom'
    });
    const m = fig.layout.margin || {};
    fig.layout.margin = Object.assign({l:40, r:20, t:50, b:40}, m);
    return fig;
  }

  function clone(o){ return window.structuredClone ? structuredClone(o) : JSON.parse(JSON.stringify(o)); }

  function renderAll() {
    const prob   = normalizeLayout(clone(FIG_PROB));
    const scores = normalizeLayout(clone(FIG_SCORES));
    const dep    = normalizeLayout(clone(FIG_DEP));
    const anx    = normalizeLayout(clone(FIG_ANX));
    const str    = normalizeLayout(clone(FIG_STR));
    Plotly.react('probChart',  prob.data,   prob.layout,   {responsive:true, displayModeBar:false});
    Plotly.react('scoreChart', scores.data, scores.layout, {responsive:true, displayModeBar:false});
    Plotly.react('depStack',   dep.data,    dep.layout,    {responsive:true, displayModeBar:false});
    Plotly.react('anxStack',   anx.data,    anx.layout,    {responsive:true, displayModeBar:false});
    Plotly.react('strStack',   str.data,    str.layout,    {responsive:true, displayModeBar:false});
  }

  renderAll();

  function setTheme(mode) {
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.setAttribute('data-bs-theme', mode);
    localStorage.setItem('theme', mode);
    renderAll();
  }
  document.getElementById('themeLight')?.addEventListener('click', () => setTheme('light'));
  document.getElementById('themeDark')?.addEventListener('click', () => setTheme('dark'));

  const media = window.matchMedia('(prefers-color-scheme: dark)');
  media.addEventListener?.('change', () => {
    const saved = localStorage.getItem('theme');
    if (!saved) setTheme(media.matches ? 'dark' : 'light');
  });

  window.addEventListener('resize', () => {
    Plotly.Plots.resize('probChart');
    Plotly.Plots.resize('scoreChart');
    Plotly.Plots.resize('depStack');
    Plotly.Plots.resize('anxStack');
    Plotly.Plots.resize('strStack');
  });
</script>
{% endif %}
</body>
</html>
